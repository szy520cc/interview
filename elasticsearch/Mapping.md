**Elasticsearch 中的 Mapping（映射）** 是定义索引字段结构的关键配置，用于指定字段名称、数据类型（如 `text`、`keyword`）、分词器（Analyzer）、是否参与索引（`index`）以及是否参与评分（`store`）等属性，支持动态映射和显式定义，是构建高效搜索与分析能力的基础。可以类比为 **MySql中的表结构**，但功能更灵活，适合处理非结构化或半结构化数据。

---

### **一、Mapping 的核心作用**
1. **定义字段的结构**  
   指定字段名称、数据类型（如 `text`、`integer`、`date` 等）、是否索引、是否存储等。
2. **控制搜索行为**  
   通过分词器（Analyzer）决定字段的搜索和索引方式（如全文搜索 vs 精确匹配）。
3. **优化查询性能**  
   通过字段的索引策略（如 `index`、`store`）和数据类型选择，提升查询效率。
4. **处理复杂数据结构**  
   支持嵌套对象（`nested`）、数组（`array`）等非结构化数据的存储和查询。

---

### **二、Mapping 的核心属性**
| **属性**           | **作用**                                                                 | **示例**                                                                 |
|--------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|
| **字段类型（type）** | 定义字段的数据类型，如 `text`、`keyword`、`integer`、`boolean` 等。         | `"title": {"type": "text"}`                                               |
| **索引（index）**    | 控制字段是否被索引（`true`/`false`）。默认为 `true`。                     | `"price": {"type": "float", "index": false}`                              |
| **分词器（analyzer）** | 指定字段的分词规则（如 `standard`、`ik_max_word`），影响搜索匹配。         | `"content": {"type": "text", "analyzer": "ik_max_word"}`                  |
| **存储（store）**    | 控制字段是否单独存储（`true`/`false`），默认为 `false`。                   | `"id": {"type": "keyword", "store": true}`                                |
| **关键字（keyword）** | 用于精确匹配（如 ID、状态码），通常与 `text` 字段配合使用。                | `"status": {"type": "keyword"}`                                           |
| **嵌套（nested）**   | 处理嵌套对象，支持独立索引和查询（类似 JSON 对象数组）。                   | `"user": {"type": "nested"}`                                              |
| **动态映射（dynamic）** | 控制是否允许自动创建新字段（`true`/`false`/`strict`）。                    | `"dynamic": "strict"`（禁止自动添加字段）                                 |

---

### **三、Mapping 的两种创建方式**
#### **1. 动态映射（Dynamic Mapping）**
- **原理**：首次写入文档时，Elasticsearch 会自动推断字段类型并生成 Mapping。
- **优点**：无需手动定义，适合快速开发。
- **缺点**：可能推断错误（如数字被识别为字符串）。
- **示例**：
  ```json
  // 写入文档后自动生成 Mapping
  {
    "title": "Elasticsearch Guide",
    "price": 59.99
  }
  ```

#### **2. 显式映射（Explicit Mapping）**
- **原理**：手动定义字段类型和规则，确保数据一致性。
- **优点**：精确控制字段行为，避免动态映射的不确定性。
- **示例**：
  ```json
  PUT /books
  {
    "mappings": {
      "properties": {
        "title": { "type": "text" },
        "price": { "type": "float" },
        "tags": { "type": "keyword" }
      }
    }
  }
  ```

---

### **四、Mapping 的高级配置**
#### **1. 动态模板（Dynamic Templates）**
- **用途**：为特定字段名或类型自动应用规则。
- **示例**：为所有以 `id_` 开头的字段设置为 `keyword` 类型。
  ```json
  "dynamic_templates": [
    {
      "string_to_keyword": {
        "match_mapping_type": "string",
        "match": "id_*",
        "mapping": { "type": "keyword" }
      }
    }
  ]
  ```

#### **2. 字段忽略策略**
- **用途**：忽略某些字段不被索引。
  ```json
  {
    "ignore_above": 100  // 忽略长度超过 100 的字段
  }
  ```

---

### **五、Mapping 的管理**
1. **查看 Mapping**  
   ```bash
   GET /<index_name>/_mapping
   ```

2. **更新 Mapping**  
   - **限制**：Elasticsearch 不允许直接修改已存在的字段类型（如 `text` 改为 `keyword`）。
   - **解决方法**：重新创建索引并迁移数据（使用 `_reindex` API）。

---

### **六、Mapping 的典型应用场景**
| **场景**               | **Mapping 配置建议**                                                                 |
|------------------------|-------------------------------------------------------------------------------------|
| **全文搜索**           | 使用 `text` 类型 + 分词器（如 `ik_max_word`），配合 `keyword` 实现精确匹配。          |
| **聚合分析**           | 使用 `keyword` 或 `numeric` 类型，避免 `text` 字段的 `fielddata` 高内存消耗。          |
| **嵌套数据**           | 使用 `nested` 类型处理 JSON 对象数组，支持独立查询。                                   |
| **避免字段冲突**       | 设置 `dynamic: "strict"` 禁止自动创建未定义字段。                                     |

---

### **七、总结**
- **Mapping 是 Elasticsearch 数据建模的核心**，直接影响搜索性能和查询结果。
- **动态映射适合快速开发**，但生产环境推荐显式定义 Mapping。
- **字段类型选择需谨慎**（如 `text` vs `keyword`），避免因类型错误导致查询失败或性能问题。



以下是 **Elasticsearch 的 Mapping** 和 **MySQL 表结构** 的对比表格，涵盖字段、索引、数据类型、灵活性等方面的核心差异：

| **对比维度**       | **Elasticsearch Mapping**                                                                 | **MySQL 表结构**                                                                 |
|--------------------|------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|
| **定义方式**       | 动态映射（自动推断字段类型）或手动定义映射（JSON 格式）。                                 | 需要显式定义表结构（DDL 语句），字段类型和约束必须提前定义。                     |
| **字段类型**       | 支持丰富的数据类型（如 `text`、`keyword`、`integer`、`date`、`nested` 等），且可自定义类型。 | 预定义的数据类型（如 `INT`、`VARCHAR`、`DATE`、`TEXT` 等），类型固定。           |
| **分词器（Analyzer）** | 映射中可指定字段的分词器（如 `standard`、`ik_max_word`），影响搜索和索引行为。             | 全文索引依赖分词（如 `ngram` 或 `MyISAM` 的 `full-text` 分词），但灵活性较低。     |
| **索引机制**       | 默认为字段创建倒排索引，支持动态配置是否存储（`store`）、是否索引（`index`）等属性。         | 需手动创建索引（如 `PRIMARY KEY`、`UNIQUE`、`INDEX`），索引与字段分离。           |
| **动态映射**       | 支持动态映射（`dynamic` 模式），可自动推断新字段的类型。                                   | 不支持动态映射，所有字段必须显式定义。                                           |
| **嵌套数据**       | 支持嵌套对象（`nested` 类型）和数组（`array` 类型），天然适合非结构化数据。                 | 需通过关联表或 JSON 类型（如 `JSON` 字段）处理嵌套数据，复杂度较高。              |
| **查询方式**       | 使用 DSL 查询（如 `match`、`term`、`range`），支持全文搜索和复杂组合查询。                 | 使用 SQL 查询（`SELECT`、`JOIN`、`WHERE`），更适合结构化查询。                   |
| **数据存储**       | 数据以 JSON 文档形式存储，字段可动态扩展。                                                 | 数据以行和列的形式存储，字段数量和类型固定。                                     |
| **性能优化**       | 通过 `fielddata` 或 `keyword` 类型优化聚合查询性能，支持分片和副本提升扩展性。               | 通过索引、分区和查询优化（如 `EXPLAIN`）提升性能，但扩展性受限于单机性能。         |
| **事务支持**       | 不支持 ACID 事务（适合读多写少的场景）。                                                  | 支持 ACID 事务（适合写多读少或强一致性场景）。                                    |
| **一致性模型**     | 最终一致性（适合高并发写入和近实时搜索）。                                                | 强一致性（适合严格事务场景）。                                                   |
| **适用场景**       | 实时搜索、日志分析、非结构化数据存储（如商品信息、用户行为日志）。                        | 传统关系型数据管理（如订单、用户表、库存管理）。                                 |

---

### **核心差异总结**
1. **灵活性**：  
   - **Elasticsearch**：动态映射、嵌套数据支持、灵活的字段类型，适合处理非结构化或半结构化数据。  
   - **MySQL**：严格的表结构定义，适合结构化数据管理。  

2. **查询能力**：  
   - **Elasticsearch**：强大的全文搜索和复杂 DSL 查询，适合实时分析。  
   - **MySQL**：SQL 查询优化成熟，适合事务性和关联查询。  

3. **扩展性**：  
   - **Elasticsearch**：水平扩展能力强，适合大规模分布式场景。  
   - **MySQL**：垂直扩展为主，分布式方案（如分库分表）复杂度高。  

4. **一致性**：  
   - **Elasticsearch**：最终一致性，适合高可用和高写入吞吐量。  
   - **MySQL**：强一致性，适合金融级事务场景。  

---

### **示例代码对比**
#### **Elasticsearch Mapping 定义**
```json
{
  "mappings": {
    "properties": {
      "title": {
        "type": "text",
        "analyzer": "ik_max_word"
      },
      "price": {
        "type": "float",
        "index": false
      },
      "tags": {
        "type": "keyword"
      }
    }
  }
}
```

#### **MySQL 表结构定义**
```sql
CREATE TABLE products (
  id INT PRIMARY KEY AUTO_INCREMENT,
  title VARCHAR(255),
  price DECIMAL(10, 2),
  tags TEXT
);
```

---

通过以上对比，可以看出 **Elasticsearch Mapping** 更适合非结构化数据的搜索和分析，而 **MySQL 表结构** 更适合传统关系型数据管理。