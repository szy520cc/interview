# Elasticsearch 高频面试题
---

## **1. 核心概念与原理**
### **1.1 ES 是什么？**
- **定义**：基于 Java 的开源分布式搜索引擎，基于 Lucene 构建，支持近实时搜索、聚合分析和分布式存储。
- **特点**：
  - **近实时性**：默认 `refresh_interval=1s`，通过内存刷新生成可搜索的 Segment。
  - **分布式架构**：通过分片（Shard）和副本（Replica）实现横向扩展。
  - **全文检索**：支持模糊搜索、短语查询、布尔查询等。
  - **RESTful API**：提供 HTTP/JSON 接口，支持多语言调用。
- **应用场景**：
  - 海量数据检索（如电商搜索、日志分析）。
  - 实时数据分析（如 ELK 栈：ES + Logstash + Kibana）。

---

### **1.2 主分片与副本分片对比**
| **特性**         | **Primary Shard**               | **Replica Shard**               |
|------------------|----------------------------------|----------------------------------|
| **写入权限**     | 可读写                           | **只读**（仅从主分片同步数据）   |
| **数据同步**     | 主分片负责数据写入               | 从主分片同步数据                 |
| **分片数修改**   | **可通过 `_shrink`/`_split` 重建** | 可动态调整数量                   |

---

### **1.3 数据更新与删除机制**
- **更新**：标记旧文档为 `.del` 文件，插入新文档（`_version` 递增），物理删除由 Segment Merge 完成。
- **删除**：标记文档为删除状态，实际物理删除通过 Segment Merge 实现。
- **Segment Merge**：合并小分片，清理被删除的文档。

---

### **1.4 Master 节点选举与脑裂防范**
- **Master 选举机制**：
  - **Quorum 机制**：需超过半数 Master 候选节点同意。
  - **版本适配配置**：
    - **ES 6.x**：`discovery.zen.minimum_master_nodes = (master_nodes/2)+1`
    - **ES 7.0+**：`cluster.initial_master_nodes: ["node1", "node2"]`
- **脑裂问题**：
  - **原因**：网络分区、节点故障。
  - **防范措施**：
    - 设置 `minimum_master_nodes`（6.x）或 `cluster.initial_master_nodes`（7.0+）。
    - 合理配置副本和分片，监控节点状态。

---

## **2. 技术点比对问题**
### **2.1 `text` 与 `keyword` 的区别**
| **特性**         | **text**                          | **keyword**                      |
|------------------|-----------------------------------|----------------------------------|
| **分词**         | 是（全文检索）                    | 否（精确匹配）                   |
| **使用场景**     | `match` 查询、全文搜索            | `term` 查询、聚合、排序          |
| **大小写敏感**   | 否（默认小写化）                  | 是（保留原始大小写）             |
| **截断长度**     | 默认不截断                        | 超过 256 字符会被忽略索引        |

---

### **2.2 `query` 与 `filter` 的区别**
| **特性**         | **query**                          | **filter**                        |
|------------------|------------------------------------|-----------------------------------|
| **相关性评分**   | 是（计算 `_score`）                | 否（不计算评分）                  |
| **缓存**         | 否                                 | 是（默认缓存结果）                |
| **性能**         | 较慢（需计算评分）                 | 快（仅过滤）                      |
| **使用场景**     | 全文搜索、布尔查询                 | 精确过滤（如日期范围、布尔条件）  |

---

### **2.3 `term` 与 `match` 的区别**
| **特性**         | **term**                          | **match**                        |
|------------------|------------------------------------|----------------------------------|
| **匹配方式**     | 精确匹配（不分词）                | 全文检索（分词）                 |
| **适用字段**     | `keyword` 字段（如 ID、标签）     | `text` 字段（如商品描述）        |
| **用途**         | 精确查询（如 `term: "ES"`）       | 全文搜索（如 `match: "Elasticsearch"`） |

---

## **3. 高频面试题补充**
### **3.1 深分页问题**
- **问题**：`from + size` 超过 10,000 时性能下降。
- **解决方案**：
  | **方法**           | **适用场景**                     | **原理**                          |
  |--------------------|----------------------------------|-----------------------------------|
  | **`search_after`** | 连续分页（如滚动加载）           | 用上一页最后一条数据的排序值作为起点 |
  | **`scroll`**       | 离线导出（非实时）               | 创建快照，固定排序上下文           |
  | **`point_in_time`** | ES 7.10+ 实时查询               | 轻量级替代 `scroll`，无状态       |

---

### **3.2 集群状态管理**
- **Master 节点职责**：维护全局集群状态（节点、索引、分片路由信息）。
- **性能瓶颈**：
  - 集群状态过大（如超 100MB）导致广播延迟。
- **优化方案**：
  - 分片数 ≤ 1000/节点，索引数 ≤ 10000。
  - 避免频繁创建/删除索引。

---

### **3.3 相关性排序优化**
- **算法选择**：
  - **BM25**（默认）：优于传统 TF-IDF，抑制高频词影响。
  - **自定义评分**：通过 `function_score` 结合业务规则（如销量、点击率）。
- **优化手段**：
  - 使用 `explain: true` 分析评分过程。
  - 对 `text` 字段配置 `norms: false` 减少内存占用。

---

### **3.4 向量检索（ES 8.0+）**
- **核心能力**：
  - 字段类型 `dense_vector` 存储向量。
  - 支持余弦、欧氏距离等相似度算法。
- **使用示例**：
  ```json
  PUT /image_index
  {
    "mappings": {
      "properties": {
        "image_vector": {
          "type": "dense_vector",
          "dims": 512
        }
      }
    }
  }
  ```
  ```json
  GET /image_index/_search
  {
    "knn": {
      "field": "image_vector",
      "query_vector": [0.1, 0.2, ...],
      "k": 10,
      "num_candidates": 100
    }
  }
  ```

---

## **4. 其他高频问题**
### **4.1 性能调优**
- **分片策略**：分片数 ≤ 1000/节点，单分片大小建议 15-30GB。
- **刷新间隔**：写入密集型场景增大 `refresh_interval`。
- **字段过滤**：使用 `_source` 过滤非必要字段。

### **4.2 数据一致性**
- **Translog 保证可靠性**：默认每 5 秒刷盘，可通过 `translog.durability: request` 避免数据丢失。

### **4.3 安全与监控**
- **RBAC 权限控制**：通过 X-Pack 配置角色和权限。
- **监控指标**：`heap memory`、`GC time`、`indexing rate`。

### **4.4 ELK 栈生态**
- **Logstash**：数据处理管道，支持日志收集、转换。
- **Beats**：轻量级数据采集器（如 Filebeat、Metricbeat）。

---

## **5. 总结**
Elasticsearch 是分布式搜索引擎，适用于海量数据的实时检索和分析。掌握其核心概念（如倒排索引、分片、副本）、原理（如写入流程、搜索机制）和调优技巧是面试重点。实际应用中需根据场景选择合适的数据类型（`text` vs. `keyword`）、查询方式（`query` vs. `filter`），并合理配置分片和副本以保证高可用性。此外，深分页优化、相关性排序、向量检索等高级特性也是高频考点。