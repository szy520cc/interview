# Redis 使用的过期删除策略

Redis 为了高效地管理键的生命周期，结合使用了**三种过期删除策略**：

1.  **惰性删除（Lazy Deletion / On-demand Deletion）**
2.  **定期删除（Active Deletion / Periodic Deletion）**
3.  **内存淘汰（Eviction Strategy）**

这三种策略协同工作，确保 Redis 在保证性能的同时，有效地回收过期键占用的内存。

---

### 1. 惰性删除（Lazy Deletion / On-demand Deletion）

* **策略：** 当客户端尝试访问（读或写）一个键时，Redis 会先检查这个键是否过期。如果发现键已经过期，Redis 会立即删除它，然后再执行客户端请求（如果请求是对键的操作）。
* **优点：**
    * 对 CPU 友好：只在需要时才检查和删除，避免了大量的 CPU 周期用于扫描过期键。
    * 保证了访问过期键时，不会返回过期数据。
* **缺点：**
    * 如果一个过期键长时间没有被访问，它会一直留在内存中，不会被及时删除。这可能导致内存的浪费，尤其是在有大量不活跃的过期键时。
* **触发时机：** 客户端执行 `GET`, `SET`, `HGETALL` 等命令访问某个键时。

---

### 2. 定期删除（Active Deletion / Periodic Deletion）

* **策略：** Redis 会在后台运行一个定时任务，周期性地随机检查一部分设置了过期时间的键，并删除其中已过期的键。
* **实现细节：**
    * Redis 维护了一个过期字典（或者说每个数据库都有一个过期字典），存储了所有设置了过期时间的键及其过期时间。
    * 每隔一段时间（默认每秒执行 10 次），Redis 的主事件循环会调用一个函数 `activeExpireCycle()`。
    * 这个函数会从过期字典中随机抽取一定数量的键（默认 20 个）。
    * 检查这些键是否过期，如果过期就删除。
    * 如果这次检查发现过期键的比例超过 25%，那么会继续重复这个过程，直到过期键的比例低于 25% 或者检查时间达到某个上限（默认 25 毫秒）。
* **优点：**
    * 弥补了惰性删除的不足，可以及时清理一部分过期键，防止内存无限制增长。
    * 通过限制每次检查的时间和键的数量，避免了对 CPU 的过度占用。
* **缺点：**
    * 随机抽样和时间限制意味着无法保证所有过期键都能被及时删除。如果过期键数量非常大且不被访问，仍然会有部分过期键长时间存在。

---

### 3. 内存淘汰（Eviction Strategy）

* **策略：** 当 Redis 运行内存达到设定的最大内存限制 (`maxmemory`)，并且有新的数据写入请求时，为了给新数据腾出空间，Redis 会根据配置的内存淘汰策略（`maxmemory-policy`）来删除一部分键。
* **作用：** 这不是直接针对过期键的策略，而是 Redis 内存管理的一种通用策略。然而，它也间接地处理了未被惰性删除和定期删除及时清理的过期键。当内存不足时，即使某个键已经过期但未被前两种策略删除，也可能根据淘汰策略被强制删除。
* **常见的淘汰策略（`maxmemory-policy`）：**
    * `noeviction`：不删除任何键，新写入会报错。
    * `allkeys-lru`：从所有键中选择最近最少使用的键进行删除。
    * `volatile-lru`：从设置了过期时间的键中选择最近最少使用的键进行删除。
    * `allkeys-lfu`：从所有键中选择最不经常使用的键进行删除。
    * `volatile-lfu`：从设置了过期时间的键中选择最不经常使用的键进行删除。
    * `allkeys-random`：从所有键中随机删除。
    * `volatile-random`：从设置了过期时间的键中随机删除。
    * `volatile-ttl`：从设置了过期时间的键中选择剩余生存时间（TTL）最短的键进行删除。
* **触发时机：** 当 Redis 内存使用量超过 `maxmemory` 限制，且有新的写入操作时。

---

### 总结

Redis 通过这三种策略的结合，实现了对过期键的有效管理：

* **惰性删除**确保了过期数据不会被读取到。
* **定期删除**作为后台清扫工，避免了内存的持续膨胀。
* **内存淘汰**则是在内存吃紧时的最后一道防线，确保 Redis 不会因内存耗尽而崩溃。

它们共同平衡了 CPU 资源消耗和内存使用效率，是 Redis 保持高性能和稳定性的重要基石。

```