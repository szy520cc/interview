```markdown
---

## Redis 混合持久化执行过程详解

Redis 4.0 引入了 **混合持久化** (Hybrid Persistence) 机制，也称为 **RDB-AOF 混合模式**。这种模式的目的是结合 RDB 和 AOF 的优点，既能享受 RDB 快照的快速启动恢复，又能拥有 AOF 接近实时的数据安全性。

在混合持久化模式下，AOF 文件不再是纯文本的命令序列，而是由**RDB 快照**和**AOF 命令**两部分组成。

---

### 混合持久化的结构

一个混合 AOF 文件大致结构如下：

```

\+---------------------+
| RDB 快照数据        |  \<-- 文件开头是 RDB 格式的二进制数据
\+---------------------+
| AOF 格式数据        |  \<-- RDB 快照之后的写入操作以 AOF 命令格式追加
| (重写期间的增量命令) |
\+---------------------+

```

---

### 混合持久化的执行过程（AOF 重写时触发）

混合持久化是在 **AOF 重写 (BGREWRITEAOF)** 期间实现的。

1.  **触发 AOF 重写：**
    * 可以通过手动执行 `BGREWRITEAOF` 命令。
    * 也可以通过配置 `auto-aof-rewrite-percentage` 和 `auto-aof-rewrite-min-size` 自动触发。

2.  **`fork` 子进程：**
    * 和传统的 AOF 重写一样，Redis **主进程**会执行 `fork()` 系统调用，创建一个**子进程**。
    * 主进程继续处理客户端请求，并将重写期间的所有新写命令追加到 **AOF 重写缓冲区**。

3.  **子进程生成 RDB 快照：**
    * 与传统 AOF 重写不同的是，子进程不再直接生成 AOF 命令，而是首先将当前内存中的**所有数据以 RDB 格式写入一个临时文件**。这一步就相当于执行了一个 `BGSAVE` 操作。
    * 这个 RDB 快照包含了重写开始时的数据状态。

4.  **子进程追加 AOF 命令：**
    * 当子进程完成 RDB 快照写入后，它会**切换模式**，开始捕获并写入**重写期间主进程追加到 AOF 重写缓冲区中的所有命令**。
    * 这些命令会以 AOF 格式追加到之前生成的 RDB 数据之后，形成一个混合格式的临时 AOF 文件。

5.  **主进程原子替换：**
    * 当子进程完成所有操作（RDB 快照生成和增量 AOF 命令追加）后，它会通知主进程。
    * 主进程会将 AOF 重写缓冲区中，子进程通知之后新产生的命令，继续追加到这个临时混合 AOF 文件的末尾（确保完整性）。
    * 最后，主进程使用**原子重命名操作**（`rename()`）将这个新的临时混合 AOF 文件替换掉旧的 AOF 文件。

---

### 混合持久化的恢复过程

当 Redis 重启并需要恢复数据时：

1.  Redis 会检测 AOF 文件。
2.  如果 AOF 文件是混合格式的，Redis 会首先加载 AOF 文件开头的 **RDB 快照数据**。这部分加载速度非常快，因为它直接将数据载入内存。
3.  加载完 RDB 部分后，Redis 会继续解析 AOF 文件中后续的**AOF 命令部分**，并逐条执行这些命令，以恢复 RDB 快照生成后到 Redis 宕机前的所有数据变更。

---

### 混合持久化的优势

* **启动恢复速度快：** Redis 重启时，大部分数据通过加载 RDB 快照快速恢复，而不是逐条执行 AOF 命令，大大缩短了启动时间。
* **数据安全性高：** 后半部分的 AOF 命令确保了 RDB 快照之后到故障发生前的数据完整性，损失的数据量与传统 AOF 相似（取决于 `appendfsync` 策略）。
* **兼容性：** 混合 AOF 文件头部的 RDB 格式可以被旧版本 Redis 识别为 RDB 文件，从而能部分恢复数据（但会忽略 AOF 部分）。

---

### 配置方式

要在 Redis 中开启混合持久化，你需要在 `redis.conf` 中确保：

* `appendonly yes` (开启 AOF)
* `aof-use-rdb-preamble yes` (开启混合持久化，这是关键配置)
```