## é™æµç®—æ³•æ·±åº¦è§£æï¼šè®¡æ•°å™¨ã€æ¼æ¡¶ã€ä»¤ç‰Œæ¡¶

### ä¸€ã€è®¡æ•°å™¨ç®—æ³•ï¼ˆå›ºå®šçª—å£ç®—æ³•ï¼‰
**æ ¸å¿ƒåŸç†**ï¼š  
åœ¨**å›ºå®šæ—¶é—´çª—å£**å†…ç»Ÿè®¡è¯·æ±‚æ¬¡æ•°ï¼Œè¶…è¿‡é˜ˆå€¼åˆ™æ‹’ç»åç»­è¯·æ±‚

```mermaid
graph LR
A[è¯·æ±‚åˆ°è¾¾] --> B{æ—¶é—´çª—å£å†…<br>è®¡æ•° < é˜ˆå€¼ï¼Ÿ}
B -->|æ˜¯| C[è®¡æ•°+1 å¤„ç†è¯·æ±‚]
B -->|å¦| D[æ‹’ç»è¯·æ±‚]
E[æ—¶é—´çª—å£ç»“æŸ] --> F[è®¡æ•°å™¨æ¸…é›¶]
```

**ç‰¹ç‚¹**ï¼š
- âœ… **ä¼˜ç‚¹**ï¼šå®ç°ç®€å•ï¼Œå†…å­˜å ç”¨å°‘
- âŒ **ç¼ºç‚¹**ï¼šå­˜åœ¨**ä¸´ç•Œçªåˆºé—®é¢˜**
  - ä¾‹ï¼šé™æµ100æ¬¡/åˆ†é’Ÿ
  - ç¬¬59ç§’æ”¶åˆ°100è¯·æ±‚ â†’ é€šè¿‡
  - ç¬¬61ç§’å†æ”¶100è¯·æ±‚ â†’ é€šè¿‡
  - å®é™…åœ¨2ç§’å†…å¤„ç†äº†200è¯·æ±‚

**é€‚ç”¨åœºæ™¯**ï¼š  
å¯¹æµé‡å¹³ç¨³æ€§è¦æ±‚ä¸é«˜çš„ç®€å•åœºæ™¯ï¼ˆå¦‚çŸ­ä¿¡éªŒè¯ç å‘é€ï¼‰

---

### äºŒã€æ¼æ¡¶ç®—æ³•ï¼ˆLeaky Bucketï¼‰
**æ ¸å¿ƒåŸç†**ï¼š  
æ¨¡æ‹Ÿæ°´æ¡¶æ¼æ°´è¿‡ç¨‹ï¼Œ**å›ºå®šé€Ÿç‡å¤„ç†è¯·æ±‚**ï¼Œæ¡¶æ»¡åˆ™æº¢å‡ºï¼ˆæ‹’ç»è¯·æ±‚ï¼‰

```mermaid
graph TB
A[è¯·æ±‚æµå…¥] --> B[æ¼æ¡¶]
B -->|å›ºå®šé€Ÿç‡æµå‡º| C[è¯·æ±‚å¤„ç†]
B -->|æ¡¶æ»¡æº¢å‡º| D[æ‹’ç»è¯·æ±‚]
```

**å…³é”®å‚æ•°**ï¼š
- **æ¡¶å®¹é‡**ï¼šæœ€å¤§ç§¯å‹è¯·æ±‚é‡
- **å‡ºæ°´é€Ÿç‡**ï¼šå›ºå®šå¤„ç†é€Ÿç‡ï¼ˆå¦‚10ä¸ª/ç§’ï¼‰

**ç‰¹ç‚¹**ï¼š
- âœ… **ä¼˜ç‚¹**ï¼š  
  â‘  å¹³æ»‘æµé‡ï¼ˆå‰Šå³°å¡«è°·ï¼‰  
  â‘¡ ä¸¥æ ¼é™åˆ¶å¤„ç†é€Ÿç‡
- âŒ **ç¼ºç‚¹**ï¼š  
  â‘  æ— æ³•åº”å¯¹çªå‘æµé‡  
  â‘¡ è¯·æ±‚å»¶è¿Ÿå¯èƒ½è¾ƒé«˜

**æ•°å­¦è¡¨è¾¾**ï¼š  
è‹¥å‡ºæ°´é€Ÿç‡ä¸º $r$ è¯·æ±‚/ç§’ï¼Œæ¡¶å®¹é‡ä¸º $b$  
åˆ™æœ€å¤§çªå‘å¤„ç†é‡ = $b$ï¼Œé•¿æœŸå¹³å‡é€Ÿç‡ â‰¤ $r$

**é€‚ç”¨åœºæ™¯**ï¼š  
éœ€è¦**æ’å®šè¾“å‡ºé€Ÿç‡**çš„åœºæ™¯ï¼ˆå¦‚APIç½‘å…³é™æµï¼‰

---

### ä¸‰ã€ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆToken Bucketï¼‰
**æ ¸å¿ƒåŸç†**ï¼š  
ç³»ç»Ÿä»¥**å›ºå®šé€Ÿç‡**å‘æ¡¶ä¸­æŠ•æ”¾ä»¤ç‰Œï¼Œè¯·æ±‚éœ€è·å–ä»¤ç‰Œæ‰èƒ½è¢«å¤„ç†

```mermaid
graph LR
A[ä»¤ç‰Œç”Ÿæˆå™¨] -->|å›ºå®šé€Ÿç‡| B[ä»¤ç‰Œæ¡¶]
C[è¯·æ±‚åˆ°è¾¾] --> D{æ¡¶ä¸­æœ‰ä»¤ç‰Œï¼Ÿ}
D -->|æ˜¯| E[å–ä»¤ç‰Œå¤„ç†è¯·æ±‚]
D -->|å¦| F[æ‹’ç»è¯·æ±‚]
```

**å…³é”®å‚æ•°**ï¼š
- **ä»¤ç‰ŒæŠ•æ”¾é€Ÿç‡**ï¼š$r$ ä¸ª/ç§’
- **æ¡¶å®¹é‡**ï¼š$b$ï¼ˆæœ€å¤§ä»¤ç‰Œæ•°ï¼‰

**ç‰¹ç‚¹**ï¼š
- âœ… **ä¼˜ç‚¹**ï¼š  
  â‘  **å…è®¸çªå‘æµé‡**ï¼ˆæœ€å¤šæ¶ˆè€— $b$ ä¸ªä»¤ç‰Œï¼‰  
  â‘¡ å…¼é¡¾çµæ´»æ€§ä¸ä¿æŠ¤æ€§
- âŒ **ç¼ºç‚¹**ï¼š  
  å®ç°è¾ƒå¤æ‚ï¼ˆéœ€ç»´æŠ¤ä»¤ç‰Œè®¡æ•°ï¼‰

**æ•°å­¦ç‰¹æ€§**ï¼š
- é•¿æœŸå¹³å‡é€Ÿç‡ â‰¤ $r$
- æœ€å¤§çªå‘å¤„ç†é‡ = $b$

**é€‚ç”¨åœºæ™¯**ï¼š  
éœ€è¦**åº”å¯¹çªå‘æµé‡**çš„åœºæ™¯ï¼ˆå¦‚ç”µå•†ç§’æ€ç³»ç»Ÿï¼‰
**ä»£ç ç¤ºä¾‹**ï¼š 
```
<?php

// æ³¨æ„ï¼šæ­¤ç¤ºä¾‹ä¸ºåŸºç¡€ä»¤ç‰Œæ¡¶é€»è¾‘ï¼Œæœªæ¶‰åŠé¢„çƒ­æ¨¡å¼ã€‚
// åœ¨ç”Ÿäº§ç¯å¢ƒï¼ŒçŠ¶æ€ï¼ˆå¦‚ $tokensAvailable å’Œ $lastRefillTimeï¼‰å¿…é¡»æŒä¹…åŒ–åˆ° Redis ç­‰å…±äº«å­˜å‚¨ä¸­ã€‚

class TokenBucket
{
    private $capacity;          // æ¡¶å®¹é‡ (b): æœ€å¤§ä»¤ç‰Œæ•°
    private $refillRate;        // ä»¤ç‰Œå¡«å……é€Ÿç‡ (r): æ¯ç§’ç”Ÿæˆçš„ä»¤ç‰Œæ•°
    private $tokensAvailable;   // å½“å‰å¯ç”¨ä»¤ç‰Œæ•°
    private $lastRefillTime;    // ä¸Šæ¬¡å¡«å……ä»¤ç‰Œçš„æ—¶é—´æˆ³

    /**
     * æ„é€ å‡½æ•°
     * @param int $capacity ä»¤ç‰Œæ¡¶çš„æœ€å¤§å®¹é‡
     * @param float $refillRate æ¯ç§’å¡«å……çš„ä»¤ç‰Œæ•°
     */
    public function __construct(int $capacity, float $refillRate)
    {
        $this->capacity = $capacity;
        $this->refillRate = $refillRate;
        $this->tokensAvailable = $capacity; // åˆå§‹æ—¶ï¼Œæ¡¶æ˜¯æ»¡çš„
        $this->lastRefillTime = microtime(true); // è·å–å½“å‰å¾®ç§’æ—¶é—´æˆ³
    }

    /**
     * å¡«å……ä»¤ç‰Œ
     */
    private function refillTokens(): void
    {
        $now = microtime(true);
        $timeElapsed = $now - $this->lastRefillTime; // è®¡ç®—é€å»çš„æ—¶é—´
        $tokensToAdd = floor($timeElapsed * $this->refillRate); // æ ¹æ®æ—¶é—´è®¡ç®—è¦æ·»åŠ çš„ä»¤ç‰Œæ•°

        if ($tokensToAdd > 0) {
            // å°†æ–°ä»¤ç‰Œæ·»åŠ åˆ°æ¡¶ä¸­ï¼Œä½†ä¸èƒ½è¶…è¿‡æ¡¶å®¹é‡
            $this->tokensAvailable = min($this->capacity, $this->tokensAvailable + $tokensToAdd);
            $this->lastRefillTime = $now; // æ›´æ–°ä¸Šæ¬¡å¡«å……æ—¶é—´
        }
    }

    /**
     * å°è¯•è·å–æŒ‡å®šæ•°é‡çš„ä»¤ç‰Œ
     * @param int $tokens è¦è·å–çš„ä»¤ç‰Œæ•°é‡ï¼Œé»˜è®¤ä¸º1
     * @return bool å¦‚æœæˆåŠŸè·å–ä»¤ç‰Œï¼Œåˆ™è¿”å› trueï¼›å¦åˆ™è¿”å› false
     */
    public function tryAcquire(int $tokens = 1): bool
    {
        $this->refillTokens(); // æ¯æ¬¡å°è¯•è·å–å‰å…ˆå¡«å……ä»¤ç‰Œ

        if ($this->tokensAvailable >= $tokens) {
            $this->tokensAvailable -= $tokens; // æ¶ˆè€—ä»¤ç‰Œ
            return true;
        }
        return false;
    }

    // å®é™…åº”ç”¨ä¸­ï¼Œæ‚¨ä¼šè¿™æ ·ä¸ Redis ç»“åˆä½¿ç”¨ï¼š
    // public static function getInstanceFromRedis(string $key, int $capacity, float $refillRate): self { /* ä» Redis åŠ è½½çŠ¶æ€ */ }
    // public function saveStateToRedis(string $key): void { /* å°†çŠ¶æ€ä¿å­˜åˆ° Redis */ }
}

// --- ä½¿ç”¨ç¤ºä¾‹ ---
// æ¨¡æ‹Ÿä¸€ä¸ªæ¯ç§’å…è®¸ 5 ä¸ªè¯·æ±‚ï¼Œæœ€å¤§çªå‘é‡ä¸º 10 çš„é™æµå™¨
$limiter = new TokenBucket(10, 5); // æ¡¶å®¹é‡ 10ï¼Œæ¯ç§’å¡«å…… 5 ä¸ªä»¤ç‰Œ

echo "å°è¯•è·å–ä»¤ç‰Œ...\n";

for ($i = 0; $i < 15; $i++) {
    if ($limiter->tryAcquire(1)) {
        echo "è¯·æ±‚ " . ($i + 1) . ": å…è®¸é€šè¿‡\n";
    } else {
        echo "è¯·æ±‚ " . ($i + 1) . ": è¢«æ‹’ç» (è¾¾åˆ°é™æµ)\n";
    }
    usleep(150000); // æš‚åœ 150 æ¯«ç§’ï¼Œæ¨¡æ‹Ÿè¯·æ±‚é—´éš”
}

?>
```
---

### ä¸‰ç®—æ³•å¯¹æ¯”è¡¨
| **ç‰¹æ€§**         | è®¡æ•°å™¨ç®—æ³•       | æ¼æ¡¶ç®—æ³•         | ä»¤ç‰Œæ¡¶ç®—æ³•       |
|------------------|------------------|------------------|------------------|
| **å¹³æ»‘æ€§**       | âŒ çªåˆºæ˜æ˜¾       | âœ… ç»å¯¹å¹³æ»‘       | âœ… ç›¸å¯¹å¹³æ»‘       |
| **çªå‘å¤„ç†**     | âŒ æ— æ³•å¤„ç†       | âŒ æ— æ³•å¤„ç†       | âœ… æ”¯æŒçªå‘       |
| **å®ç°å¤æ‚åº¦**   | â­ ç®€å•          | â­â­ ä¸­ç­‰         | â­â­ ä¸­ç­‰         |
| **å†…å­˜æ¶ˆè€—**     | ä½ï¼ˆä»…è®¡æ•°ï¼‰     | ä¸­ï¼ˆéœ€é˜Ÿåˆ—ï¼‰     | ä½ï¼ˆä»…ä»¤ç‰Œæ•°ï¼‰   |
| **å…¸å‹åº”ç”¨**     | ç®€å•é¢‘ç‡é™åˆ¶     | æ’å®šé€Ÿç‡è¾“å‡º     | å¼¹æ€§æµé‡æ§åˆ¶     |
| **æµé‡æ§åˆ¶æ–¹å‘** | æ§åˆ¶è¾“å…¥æ€»é‡     | æ§åˆ¶è¾“å‡ºé€Ÿç‡     | æ§åˆ¶æ¶ˆè´¹èƒ½åŠ›     |

---

### å·¥ç¨‹å®è·µå»ºè®®
1. **è®¡æ•°å™¨ä¼˜åŒ–** â†’ æ»‘åŠ¨çª—å£è®¡æ•°å™¨
   - å°†å¤§çª—å£æ‹†åˆ†ä¸ºå¤šä¸ªå­çª—å£
   - ä¾‹ï¼š1åˆ†é’Ÿé™æµ100æ¬¡ â†’ æ‹†åˆ†ä¸º6ä¸ª10ç§’å­çª—å£ï¼ˆæ¯ä¸ªé™æµ17æ¬¡ï¼‰

2. **ä»¤ç‰Œæ¡¶å˜ç§** â†’ é¢„çƒ­æ¨¡å¼ï¼ˆGuava RateLimiterï¼‰
   ```java
   // Guava ä»¤ç‰Œæ¡¶å®ç°ç¤ºä¾‹
   RateLimiter limiter = RateLimiter.create(
     5, // æ¯ç§’5ä¸ªä»¤ç‰Œ
     2, // é¢„çƒ­æ—¶é—´2ç§’
     TimeUnit.SECONDS);
   ```

3. **æ··åˆç­–ç•¥**ï¼š
   - å¤–å±‚ï¼šä»¤ç‰Œæ¡¶åº”å¯¹çªå‘æµé‡
   - å†…å±‚ï¼šæ¼æ¡¶ä¿è¯æ’å®šå¤„ç†é€Ÿç‡

> ğŸ“Œ **é»„é‡‘æ³•åˆ™**ï¼š  
> - éœ€è¦**ä¸¥æ ¼å¹³æ»‘** â†’ é€‰æ¼æ¡¶  
> - éœ€è¦**å¼¹æ€§çªå‘** â†’ é€‰ä»¤ç‰Œæ¡¶  
> - è¿½æ±‚**ç®€å•å®ç°** â†’ ç”¨ä¼˜åŒ–ç‰ˆè®¡æ•°å™¨